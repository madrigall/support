/* Created by Andrey Kovtunenko Support_System_Engine - v1.0.0.0 - 2016-02-04 */
function GET_var(a,b){var c=a.match("\\?"+b+"=(\\w+)");return null!=c?c[1]:null}function modal(a,b,c){this.overlay="<div id='"+a+"'class='modal-overlay'></div>",c?this.content="<div class='modal-content'><button class='modal-action' data-modal-close='true'><i id='modal-button' class='fa fa-times fa-lg'></i></button><img style='max-width:100%;' src='"+c+"' alt=''></div>":this.content="<div class='modal-content'><button class='modal-action' data-modal-close='true'><i id='modal-button' class='fa fa-times fa-lg'></i></button><p>"+b+"</p></div>",$(this.overlay).insertBefore("header"),$(this.content).appendTo("#"+a).addClass("animated bounce"),$("#"+a).delay(1e3).fadeOut(200,function(){$(this).remove()})}function dialog(a,b,c){this.overlay="<div id='"+a+"'class='dialog-overlay'></div>",this.content="<div class='dialog-content'><p class='dialog-title'>"+b+"<hr></p><br><p>"+c+"</p><br><button id='dialog-yes-"+a+"' class='dialog-button'><i id='dialog-yes-"+a+"' class='fa fa-check'></i></button><button id='dialog-no-"+a+"' class='dialog-button'><i id='dialog-no-"+a+"' class='fa fa-times'></i></button></div>",$(this.overlay).insertBefore("header"),$(this.content).appendTo("#"+a).addClass("animated bounce")}function ajaxJSON(a,b,c){var d=!1;if(!d)var e=$.ajax({url:a,method:b,data:c,beforeSend:function(){d=!0}}).done(function(a,b,c){d=!1}).fail(function(a,b,c){modal("message-error","Ошибка при отправке запроса!"),d=!1});return e}jQuery(function(){var a,b=(window.location.host,window.innerWidth),c=(window.innerHeight,new Array);$("#u-add-support-v, #support_edit_form").validationEngine(),$("#ticket_content").hide(),$("input").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square_green",increaseArea:"20%"}),$(".checkbox-users,.select-all-users,.add-answer").iCheck({checkboxClass:"icheckbox_square-blue",radioClass:"iradio_square_blue",increaseArea:"20%"}),$(".select-all-users.head").on("ifClicked",function(a){$(this).on("ifChecked",function(){$(".checkbox-users").iCheck("check"),$(".select-all-users.foot").iCheck("check")}),$(this).on("ifUnchecked",function(){$(".checkbox-users").iCheck("uncheck"),$(".select-all-users.foot").iCheck("uncheck")})}),$(".select-all-users.foot").on("ifClicked",function(a){$(this).on("ifChecked",function(){$(".checkbox-users").iCheck("check"),$(".select-all-users.head").iCheck("check")}),$(this).on("ifUnchecked",function(){$(".checkbox-users").iCheck("uncheck"),$(".select-all-users.head").iCheck("uncheck")})}),$(".checkbox-users").each(function(){$(this).on("ifChecked",function(){$(".u-action-panel").show()}),$(this).on("ifUnchecked",function(){$(".u-action-panel").hide()})}),$(".menu-mobile").click(function(){var a=$(".cbp-vimenu").css("left");$(".cbp-vimenu li a span").remove();var b=parseInt($(".cbp-vimenu li").css("width")),c=parseInt($(".menu-mobile").css("width")),d=(b-c)/2;"-70px"===a?($(".cbp-vimenu").css("left","0px"),$(".notification").css("right","-10px"),$(".menu-mobile").css("padding-left",-d),$("#info_in_head").css("display","table-cell")):($(".cbp-vimenu").css("left","-70px"),$(".menu-mobile").css("padding-left","0"),$("#info_in_head").css("display","none"))}),tinymce.init({selector:"textarea#form-message-text, #support-answer textarea",plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste save"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",skin:"light",content_css:"../core/tinymce/js/tinymce/skins/light/style.css",theme_advanced_resizing:!0,setup:function(b){b.on("keypress",function(b){a.emit("typing")})}}),$(window).resize(function(){var a=$(window).width();a>900&&$(".main-navigation").is(":hidden")&&$(".main-navigation").removeAttr("style")}),jQuery(document).ready(function(){function d(){a.emit("give_me_users",!0)}function e(a,b){$(".user-online").fadeTo(a/2,b,function(){$(".user-online").fadeTo(a/2,1)}),$(".support-online").fadeTo(a/2,b,function(){$(".support-online").fadeTo(a/2,1)})}var f,g=GET_var(window.location.search,"ticket_id");a=io.connect("http://localhost:22333"),a.on("connect",function(b){a.emit("new_connection",key),window.location.search=="?ticket_id="+g&&a.emit("join_to_room",g),a.on("recived_message_from_user",function(a){$(a).insertAfter(".message-wrapper:last-child").addClass("animated slideInRight")}),a.on("recived_message_n",function(a){a&&$.jGrowl("У вас новое сообщение!")}),a.on("close_ticket_to_support",function(a){window.location.search=="?ticket_id="+a&&(modal("ticket-closed","Пользователь закрыл данный тикет!"),$(".wrapper-form").remove())}),a.on("user_typing",function(a){$(".typing").text("Печатает..."),window.setTimeout(function(){$(".typing").text("")},2500)}),a.on("online",function(a){c.sup=a[0],c.user=a[1],window.location.search=="?ticket_id="+g&&(c.sup.forEach(function(a,b){$(".support-"+a).addClass("support-online")}),c.user.forEach(function(a,b){$(".user-"+a).addClass("user-online")}),e(2e3,.4),f=setInterval(function(){e(950,.6)},1500),$(".user-online").each(function(){var a=$(this).data("value");"-1"==$.inArray(a,c.user)&&$(".user-"+a).removeClass("user-online")}),$(".support-online").each(function(){var a=$(this).data("value");"-1"==$.inArray(a,c.user)&&$(".user-"+a).removeClass("user-online")}))}),a.on("new_ticket_s",function(a,b){var c={ticket_id:a,support_id:b,submit_message:!0};ajaxJSON("modules/update-tickets.php","POST",c).done(function(a){var b=$.parseJSON(a);b.ticket&&($.jGrowl("У вас новый тикет!"),$("*").is(".statement-container .row")?$(".statement-container .row").prepend(b.ticket):($("<div class='row'>").insertAfter($("#main-container .information-message")),$("#main-container .row").append(b.ticket)))})}),setInterval(d,2e4)}),$("#page-loading").hide(),$("#settings-tabs li a").click(function(a){a.preventDefault(),$(this).tab("show")}),$(window).scroll(function(){b>=600?$(window).scrollTop()>=$("header").height()?($(".cbp-vimenu").stop().animate({"margin-top":"0"},100),$(".cbp-vimenu li a.icon-logo").css({display:"block"},100)):($(".cbp-vimenu li a.icon-logo").css({display:"none"},100),$(".cbp-vimenu").stop().animate({"margin-top":"70px"},100)):$(window).scrollTop()>=$("header").height()?($(".cbp-vimenu").stop().animate({"margin-top":"0"},0),$(".cbp-vimenu li a.icon-logo").css({display:"block"},0)):($(".cbp-vimenu li a.icon-logo").css({display:"none"},0),$(".cbp-vimenu").stop().animate({"margin-top":"70px"},0))}),$(".main-navigation .cbp-vimenu li a").each(function(){var a=window.location.href,b=this.href,c=GET_var(window.location.search,"ticket_id");window.location.search==="?ticket_id="+c&&$("a[href='?mode=tickets']").parent().addClass("cbp-vicurrent"),a===b&&$(this).parent().addClass("cbp-vicurrent")}),$("#support-message-add").click(function(){var b=$("#ticket-id").val(),c=$("#support-id").val(),d=tinyMCE.activeEditor.getContent(),e={ticket_id:b,message:d,submit_message:!0,support_id:c};return ajaxJSON("modules/add-support-message.php","POST",e).done(function(b){var c=$.parseJSON(b);c.error?modal("message-error",c.error):c.content&&($("#page-loading").css("background","none"),$("#page-loading").show(),$(c.content).insertAfter(".message-wrapper:last-child").addClass("animated slideInRight"),a.emit("new_message_from_support",c.to_user),tinyMCE.activeEditor.setContent(""),$("#page-loading").delay(100).fadeOut(0))}),!1}),$("#add-category").click(function(){var a=$("#category-name").val(),b={"add-category":"true",category:a};return ajaxJSON("modules/add-category.php","POST",b).done(function(b){var c=$.parseJSON(b);c.error?modal("message-error",c.error):c.done&&($(".categories").append($('<span class="tag"><span class="tag-content">'+a+'</span><a href="#" class="delete-category"><i class="fa fa-times my-times"></a></i></span>')).addClass("jello"),$('<span class="tag answers-tag"><div class="icheckbox_square-blue" style="position: relative;"><input class="add-answer" type="checkbox" style="position: absolute; top: -20%; left: -20%; display: block; width: 140%; height: 140%; margin: 0px; padding: 0px; border: 0px; opacity: 0; background: rgb(255, 255, 255);"><ins class="iCheck-helper" style="position: absolute; top: -20%; left: -20%; display: block; width: 140%; height: 140%; margin: 0px; padding: 0px; border: 0px; opacity: 0; background: rgb(255, 255, 255);"></ins></div><span class="tag-content answers-content">'+a+"</span></span>").insertAfter(".last"),$("#sup-answ").append($('<div class="support-answers"><div class="support-cat-name">'+a+'</div><p class="description margin-top-bottom">Ответов нет.</p></div>')).addClass("fadeInRight"),$("#category-name").val(""))}),!1}),$(".delete-category").click(function(){var a=$(this).parent().text(),b=$(this).parent().attr("id"),c={"delete-category":"true",category:a};return ajaxJSON("modules/delete-category.php","POST",c).done(function(a){var c=$.parseJSON(a);c.error?modal("message-error",c.error):c.done&&($("span#"+b+".tag.answers-tag").remove(),$("div#"+b+".support-answers").remove(),$("#"+b).remove())}),!1}),$(".delete-answer-b").click(function(){var a=$(this).attr("id"),b={"delete-answer":"true",id:a};return ajaxJSON("modules/delete-answer.php","POST",b).done(function(b){var c=$.parseJSON(b);c.error?modal("message-error",c.error):c.done&&$("#"+a+".answers").remove()}),!1}),b>=600&&($(".open.message-wrapper#support-message").draggable({revert:!0,zIndex:1,start:function(a){$(this).addClass("draggable")},stop:function(){$(this).removeClass("draggable")}}),$(".error-info .modal-action").click(function(){window.location.href="/admin"}),$("#delete-area").droppable({activeClass:"delete-show",hoverClass:"hover-delete-area",drop:function(){var b=$(".draggable"),c=$(b).find(".message").attr("id"),d=$(b).attr("id");dialog("delete-message","Удаление","Вы действительно хотите удалить сообщени?"),$(".dialog-button").click(function(e){if("dialog-yes-delete-message"===e.target.id){var f=$(this),g={delete_message:!0,message_id:c,written_by:d};ajaxJSON("modules/delete-message.php","POST",g).done(function(d){console.log(d);var e=$.parseJSON(d);e.done?($(b).remove(),a.emit("delete_message",c),$("#delete-message").remove(),modal("message-delete-info",e.done)):e.error&&($(f).parent().parent().remove(),modal("message-delete-error",e.error))})}"dialog-no-delete-message"===e.target.id&&$("#delete-message").remove()})}}))})});